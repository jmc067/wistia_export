$(function(){var g,d;var s=false;var l=0;var m={};var r={};var c=[];var f={};var j=1;var k="7ea1206fc22043174d677592dad08c53488821253376ef1adad77c75a9b586e1";var v=70;var x=1000;var q=x*v;var t=90;var p=20;function h(){var B="";var z="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var A=0;A<5;A++){B+=z.charAt(Math.floor(Math.random()*z.length))}return B}function b(z){console.log(z)}function e(z){$("#status").html(z+"...")}function i(B){var E="";var z="";for(var D in B[0]){var C=B[0];if(z!=""){z+=","}z+=D}E+=z+"\r\n";for(var A=0;A<B.length;A++){var z="";for(var D in B[A]){var C=B[A];if(z!=""){z+=","}z+=C[D]}E+=z+"\r\n"}return E}function w(z,A){a=document.createElement("a");a.textContent=A;a.download=A;a.href="data:text/csv;charset=utf-8,"+escape(z);document.getElementById("action_buttons").appendChild(a)}function n(){e("Converting Events To CSV");csv=i(c);e("Converting Events To CSV");var A=c[0].received_at;var z=c[c.length-1].received_at;var B=A+"->"+z+"_events_export_download-"+h()+".csv";csv=i(c);c=[];e("Ready For Download");w(csv,B)}function o(z,B){var A={received_at:z.received_at,ip:z.ip,country:z.country,region:z.region,city:z.city,lat:z.lat,lon:z.lon,percent_viewed:z.percent_viewed,embed_url:z.embed_url,media_id:z.media_id,media_name:z.media_name,media_url:z.media_url,email:z.email};if(B){A.visitor_name=B.visitor_identity["name"],A.visitor_email=B.visitor_identity["email"],A.org_name=B.visitor_identity["org"]["name"],A.org_title=B.visitor_identity["org"]["title"],A.browser=B.user_agent_details["browser"],A.browser_version=B.user_agent_details["browser_version"],A.platform=B.user_agent_details["platform"],A.mobile=B.user_agent_details["mobile"]}else{A.visitor_name=null;A.visitor_email=null;A.org_name=null;A.org_title=null;A.browser=null;A.browser_version=null;A.platform=null;A.mobile=null}if((f[A.received_at])||(f[A.received_at]==A.received_at)){b("Repeated Data.  Removing...")}else{b(A.received_at);f[A.received_at]=A.ip;c.push(A)}e("Formatted Events Page: "+j)}function y(){if(l==p){n()}if(l<t){jQuery.ajax({data:{start_date:g,end_date:d,per_page:100,page:j,sort_by:"created",sort_direction:1},url:"https://api.wistia.com/v1/stats/events.json?api_password="+k,success:function(E){l+=1;e("Downloaded Events.  Page: "+j);var A=c.length;for(var C=0;C<E.length;C++){var z=E[C];var B=E[C]["visitor_key"];var D=r[B];o(z,D)}if(A!=c.length){j+=1;b("page!!!!!!!!!! "+j);y()}else{n()}}}).fail(function(){e("Export Failed: Error Retrieving Events")})}else{e("Reached Request Limit.  Waiting 60 seconds....");setTimeout(function(){l=0;y()},q)}}function u(){e("Retrieving Selected Dates");e("Triggered Export");jQuery.ajax({url:"https://api.wistia.com/v1/medias.json?api_password="+k,success:function(B){l+=1;for(var z=0;z<B.length;z++){var A=B[z];m[A.hashed_id]=A}jQuery.ajax({url:"https://api.wistia.com/v1/stats/visitors.json?api_password="+k,success:function(E){l+=1;e("Downloaded Visitors");for(var C=0;C<E.length;C++){var D=E[C];r[D.visitor_key]=D}y()}}).fail(function(){e("Export Failed: Error Retrieving Visitors")})}}).fail(function(){e("Export Failed: Error Retrieving Medias")})}$("#daterangepicker").daterangepicker({autoUpdateInput:false,locale:{cancelLabel:"Clear"}});$("#daterangepicker").on("apply.daterangepicker",function(A,z){g=z.startDate.format("YYYY-MM-DD");d=z.endDate.format("YYYY-MM-DD");$("#start_date_display").text("Start Date: "+g);$("#end_date_display").text("End Date: "+d);u()});$("#daterangepicker").on("cancel.daterangepicker",function(A,z){$(this).val("")})});